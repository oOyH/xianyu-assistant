<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登录 - 闲鱼自动回复管理系统</title>

  <!-- Favicon 图标集 -->
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <meta name="theme-color" content="#007aff">

  <link rel="stylesheet" href="/static/lib/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="/static/lib/bootstrap-icons/bootstrap-icons.css">
  <style>
    /* Liquid Glass 设计系统变量 */
    :root {
      /* 字体系统 - Apple San Francisco 风格 */
      --font-family-system: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;

      /* 浅色模式调色板 */
      --bg-color-light: #f8fafc;
      --bg-image-light: linear-gradient(120deg, #fdfbfb 0%, #f1f5f9 100%);
      --text-color-light: #1e293b;
      --text-color-secondary-light: #64748b;
      --text-color-muted-light: #94a3b8;
      --accent-color-light: #3b82f6;
      --glass-bg-light: rgba(248, 250, 252, 0.85);
      --glass-border-light: rgba(255, 255, 255, 0.6);
      --shadow-color-light: rgba(0, 0, 0, 0.08);
      --card-text-light: #1e293b;
      --header-text-light: #ffffff;

      /* 深色模式调色板 */
      --bg-color-dark: #0f172a;
      --bg-image-dark: linear-gradient(120deg, #1e293b 0%, #334155 100%);
      --text-color-dark: #f1f5f9;
      --text-color-secondary-dark: #cbd5e1;
      --text-color-muted-dark: #94a3b8;
      --accent-color-dark: #60a5fa;
      --glass-bg-dark: rgba(15, 23, 42, 0.85);
      --glass-border-dark: rgba(255, 255, 255, 0.1);
      --shadow-color-dark: rgba(0, 0, 0, 0.3);
      --card-text-dark: #f1f5f9;
      --header-text-dark: #ffffff;

      /* 当前主题变量 (默认浅色模式) */
      --bg-color: var(--bg-color-light);
      --bg-image: var(--bg-image-light);
      --text-color: var(--text-color-light);
      --text-color-secondary: var(--text-color-secondary-light);
      --text-color-muted: var(--text-color-muted-light);
      --accent-color: var(--accent-color-light);
      --glass-bg: var(--glass-bg-light);
      --glass-border: var(--glass-border-light);
      --shadow-color: var(--shadow-color-light);
      --card-text: var(--card-text-light);
      --header-text: var(--header-text-light);

      /* 设计系统变量 */
      --radius-2xl: 1.5rem;
      --shadow-md: 0 10px 25px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
      --transition-fluid: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-quick: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);

      /* 兼容旧变量 */
      --primary-color: var(--accent-color);
      --secondary-color: var(--text-color-secondary);
      --success-color: #10b981;
      --danger-color: #ef4444;
    }

    /* 深色模式 */
    [data-theme="dark"] {
      --bg-color: var(--bg-color-dark);
      --bg-image: var(--bg-image-dark);
      --text-color: var(--text-color-dark);
      --text-color-secondary: var(--text-color-secondary-dark);
      --text-color-muted: var(--text-color-muted-dark);
      --accent-color: var(--accent-color-dark);
      --glass-bg: var(--glass-bg-dark);
      --glass-border: var(--glass-border-dark);
      --shadow-color: var(--shadow-color-dark);
      --card-text: var(--card-text-dark);
      --header-text: var(--header-text-dark);
    }

    /* 深色模式文字优化 */
    [data-theme="dark"] .form-label,
    [data-theme="dark"] .form-text,
    [data-theme="dark"] .text-muted,
    [data-theme="dark"] small,
    [data-theme="dark"] .small {
      color: var(--text-color-secondary) !important;
    }

    [data-theme="dark"] .text-decoration-none {
      color: var(--accent-color) !important;
    }

    [data-theme="dark"] .btn-outline-secondary {
      color: var(--text-color) !important;
      border-color: var(--glass-border) !important;
    }

    [data-theme="dark"] .btn-outline-secondary:hover {
      background: color-mix(in srgb, var(--accent-color) 10%, var(--glass-bg)) !important;
      border-color: var(--accent-color) !important;
      color: var(--accent-color) !important;
    }

    /* 深色模式下的状态文字 */
    [data-theme="dark"] #captchaStatus,
    [data-theme="dark"] #codeStatus,
    [data-theme="dark"] .form-text {
      color: var(--text-color-secondary) !important;
    }

    /* 深色模式下的链接文字 */
    [data-theme="dark"] a {
      color: var(--accent-color) !important;
    }

    [data-theme="dark"] a:hover {
      color: color-mix(in srgb, var(--accent-color) 80%, white) !important;
    }

    body {
      font-family: var(--font-family-system);
      background: var(--bg-image);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fluid);
    }
    
    .login-container {
      background: var(--glass-bg);
      backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      width: 100%;
      max-width: 400px;
      transition: var(--transition-fluid);
    }

    .login-header {
      background: linear-gradient(135deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 80%, #8b5cf6) 100%);
      color: var(--header-text);
      padding: 30px;
      text-align: center;
      border-bottom: 1px solid var(--glass-border);
    }
    
    .login-header h2 {
      margin: 0;
      font-weight: 600;
    }
    
    .login-header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
    }
    
    .login-body {
      padding: 40px 30px;
      background: var(--glass-bg);
      color: var(--card-text);
    }

    .form-control {
      background: var(--glass-bg) !important;
      backdrop-filter: blur(10px) saturate(150%) !important;
      -webkit-backdrop-filter: blur(10px) saturate(150%) !important;
      border: 1px solid var(--glass-border) !important;
      border-radius: var(--radius-2xl) !important;
      color: var(--text-color) !important;
      padding: 12px 15px !important;
      font-size: 16px !important;
      transition: var(--transition-fluid) !important;
    }

    .form-control:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent-color) 20%, transparent);
      outline: none;
    }

    .form-control::placeholder {
      color: var(--text-color-muted) !important;
    }

    /* 深色模式占位符优化 */
    [data-theme="dark"] .form-control::placeholder {
      color: var(--text-color-muted) !important;
      opacity: 0.8;
    }

    .btn-login {
      background: linear-gradient(135deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 90%, #8b5cf6) 100%) !important;
      border: none !important;
      border-radius: var(--radius-2xl) !important;
      color: white !important;
      padding: 12px !important;
      font-size: 16px !important;
      font-weight: 600 !important;
      width: 100% !important;
      transition: var(--transition-quick) !important;
      box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-color) 30%, transparent) !important;
    }

    .btn-login:hover {
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent-color) 90%, black) 0%, color-mix(in srgb, var(--accent-color) 80%, #8b5cf6) 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px color-mix(in srgb, var(--accent-color) 40%, transparent);
    }
    
    .input-group {
      position: relative;
      margin-bottom: 20px;
    }
    
    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-color-muted);
      z-index: 100;
      pointer-events: none;
      transition: var(--transition-quick);
    }

    .input-group:focus-within i {
      color: var(--accent-color);
    }

    .input-group .form-control {
      padding-left: 45px !important;
    }

    .alert {
      background: var(--glass-bg);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-2xl);
      color: var(--text-color);
      box-shadow: var(--shadow-md);
    }

    .alert-danger {
      background: color-mix(in srgb, var(--danger-color) 10%, var(--glass-bg));
      border-color: color-mix(in srgb, var(--danger-color) 30%, var(--glass-border));
      color: var(--danger-color);
    }
    
    .btn-group .btn {
      background: var(--glass-bg);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-2xl) !important;
      color: var(--text-color);
      font-size: 0.9rem;
      padding: 8px 16px;
      transition: var(--transition-quick);
      font-weight: 500;
    }

    .btn-group .btn:hover {
      background: color-mix(in srgb, var(--accent-color) 10%, var(--glass-bg));
      border-color: var(--accent-color);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-color) 20%, transparent);
    }

    .btn-group .btn.active,
    .btn-group .btn:checked + .btn {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
      box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-color) 30%, transparent);
    }

    .btn-outline-primary {
      border-color: var(--glass-border);
      color: var(--text-color);
    }

    .btn-outline-primary:hover {
      background: color-mix(in srgb, var(--accent-color) 10%, var(--glass-bg));
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .btn-outline-primary.active,
    .btn-check:checked + .btn-outline-primary {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }

    .loading {
      display: none;
    }

    .loading.show {
      display: inline-block;
    }

    .loading .spinner-border {
      border-color: var(--accent-color);
      border-right-color: transparent;
    }

    /* 主题切换按钮 */
    .theme-toggle-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .theme-toggle-btn {
      background: var(--glass-bg);
      backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-color);
      font-size: 1.2rem;
      cursor: pointer;
      transition: var(--transition-quick);
      box-shadow: var(--shadow-md);
    }

    .theme-toggle-btn:hover {
      background: color-mix(in srgb, var(--accent-color) 10%, var(--glass-bg));
      border-color: var(--accent-color);
      color: var(--accent-color);
      transform: scale(1.05);
      box-shadow: 0 8px 25px color-mix(in srgb, var(--accent-color) 25%, transparent);
    }

    .theme-toggle-btn:active {
      transform: scale(0.95);
    }

    /* ================================
       移动端响应式优化
       ================================ */

    /* 超小屏设备优化 (xs: 0-575px) */
    @media (max-width: 575.98px) {
      body {
        padding: 1rem;
        align-items: flex-start;
        padding-top: 2rem;
        font-size: 16px; /* 防止iOS自动缩放 */
      }

      .login-container {
        max-width: 100%;
        margin: 0;
        border-radius: var(--radius-2xl);
        min-height: auto;
        box-shadow: var(--shadow-md);
      }

      .login-header {
        padding: 1.5rem 1rem;
        background: linear-gradient(135deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 80%, #8b5cf6) 100%);
      }

      .login-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .login-header p {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0;
      }

      .login-header .fs-1 {
        font-size: 2.5rem !important;
        margin-bottom: 1rem !important;
      }

      .login-body {
        padding: 1.5rem 1rem;
        background: var(--glass-bg);
      }

      .form-control {
        padding: 0.875rem 1rem !important;
        font-size: 16px !important; /* 防止iOS缩放 */
        border-radius: var(--radius-2xl) !important;
        min-height: 48px !important; /* 触摸友好 */
        background: var(--glass-bg) !important;
        border: 1px solid var(--glass-border) !important;
        color: var(--text-color) !important;
      }

      .input-group .form-control {
        padding-left: 3rem;
      }

      .input-group i {
        left: 1rem;
        color: var(--text-color-muted);
      }

      .btn-login {
        padding: 0.875rem;
        font-size: 16px;
        border-radius: var(--radius-2xl);
        min-height: 48px; /* 触摸友好 */
        font-weight: 600;
        background: linear-gradient(135deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 90%, #8b5cf6) 100%);
        box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-color) 30%, transparent);
      }

      .btn-group .btn {
        font-size: 0.875rem;
        padding: 0.625rem 0.75rem;
        min-height: 44px;
        border-radius: var(--radius-2xl) !important;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-color);
      }

      .input-group {
        margin-bottom: 1rem;
      }

      .alert {
        font-size: 0.875rem;
        padding: 0.75rem;
        border-radius: var(--radius-2xl);
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
      }

      /* 主题切换按钮移动端优化 */
      .theme-toggle-container {
        top: 1rem;
        right: 1rem;
      }

      .theme-toggle-btn {
        width: 44px;
        height: 44px;
        font-size: 1.1rem;
      }
    }

    /* 小屏手机横屏 (sm: 576px-767px) */
    @media (min-width: 576px) and (max-width: 767.98px) {
      body {
        padding: 15px;
        padding-top: 30px;
      }

      .login-container {
        max-width: 450px;
        border-radius: 18px;
      }

      .login-header {
        padding: 25px 20px;
      }

      .login-body {
        padding: 30px 20px;
      }

      .form-control {
        padding: 12px 15px;
        font-size: 15px;
      }

      .btn-login {
        padding: 12px;
        font-size: 15px;
        min-height: 44px;
      }
    }

    /* 平板竖屏 (md: 768px+) */
    @media (min-width: 768px) {
      body {
        padding: 20px;
      }

      .login-container {
        max-width: 400px;
      }

      .login-header {
        padding: 30px;
      }

      .login-body {
        padding: 40px 30px;
      }
    }

    /* 触摸设备特定优化 */
    @media (hover: none) and (pointer: coarse) {
      .btn-login:hover {
        transform: none;
        background: linear-gradient(135deg, var(--accent-color) 0%, color-mix(in srgb, var(--accent-color) 90%, #8b5cf6) 100%);
      }

      .btn-login:active {
        transform: scale(0.98);
        background: linear-gradient(135deg, color-mix(in srgb, var(--accent-color) 90%, black) 0%, color-mix(in srgb, var(--accent-color) 80%, #8b5cf6) 100%);
      }

      .btn-group .btn:hover {
        transform: none;
        background: var(--glass-bg);
      }

      .btn-group .btn:active {
        transform: scale(0.95);
        background: color-mix(in srgb, var(--accent-color) 10%, var(--glass-bg));
      }

      .theme-toggle-btn:hover {
        transform: none;
        background: var(--glass-bg);
      }

      .theme-toggle-btn:active {
        transform: scale(0.95);
        background: color-mix(in srgb, var(--accent-color) 10%, var(--glass-bg));
      }

      /* 确保触摸目标足够大 */
      .btn,
      .form-control,
      .theme-toggle-btn {
        min-height: 44px;
      }
    }

    /* 横屏模式优化 */
    @media (max-height: 600px) and (orientation: landscape) {
      body {
        align-items: flex-start;
        padding-top: 10px;
      }

      .login-header {
        padding: 15px 20px;
      }

      .login-header .fs-1 {
        font-size: 2rem !important;
        margin-bottom: 0.5rem !important;
      }

      .login-header h2 {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
      }

      .login-header p {
        font-size: 0.875rem;
        margin: 0;
      }

      .login-body {
        padding: 20px;
      }

      .input-group {
        margin-bottom: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- 主题切换按钮 -->
  <div class="theme-toggle-container">
    <button class="theme-toggle-btn" onclick="toggleTheme()" title="切换主题">
      <i class="bi bi-sun-fill" id="themeIcon"></i>
    </button>
  </div>

  <div class="login-container">
    <div class="login-header">
      <i class="bi bi-chat-dots-fill fs-1 mb-3"></i>
      <h2>闲鱼自动回复</h2>
      <p>管理系统登录</p>
    </div>
    
    <div class="login-body">
      <!-- 登录方式选择 -->
      <div class="login-tabs mb-4">
        <div class="btn-group w-100" role="group">
          <input type="radio" class="btn-check" name="loginType" id="usernameLogin" value="username" checked>
          <label class="btn btn-outline-primary" for="usernameLogin">用户名/密码</label>

          <input type="radio" class="btn-check" name="loginType" id="emailPasswordLogin" value="email-password">
          <label class="btn btn-outline-primary" for="emailPasswordLogin">邮箱/密码</label>

          <input type="radio" class="btn-check" name="loginType" id="emailCodeLogin" value="email-code">
          <label class="btn btn-outline-primary" for="emailCodeLogin">邮箱/验证码</label>
        </div>
      </div>

      <form id="loginForm">
        <!-- 用户名/密码登录 -->
        <div id="usernameLoginForm" class="login-form-section">
          <div class="input-group">
            <i class="bi bi-person-fill"></i>
            <input type="text" class="form-control" id="username" placeholder="请输入用户名">
          </div>

          <div class="input-group">
            <i class="bi bi-lock-fill"></i>
            <input type="password" class="form-control" id="password" placeholder="请输入密码">
          </div>
        </div>

        <!-- 邮箱/密码登录 -->
        <div id="emailPasswordLoginForm" class="login-form-section" style="display: none;">
          <div class="input-group">
            <i class="bi bi-envelope-fill"></i>
            <input type="email" class="form-control" id="emailForPassword" placeholder="请输入邮箱地址">
          </div>

          <div class="input-group">
            <i class="bi bi-lock-fill"></i>
            <input type="password" class="form-control" id="emailPassword" placeholder="请输入密码">
          </div>
        </div>

        <!-- 邮箱/验证码登录 -->
        <div id="emailCodeLoginForm" class="login-form-section" style="display: none;">
          <div class="input-group">
            <i class="bi bi-envelope-fill"></i>
            <input type="email" class="form-control" id="emailForCode" placeholder="请输入邮箱地址">
          </div>

          <!-- 图形验证码 -->
          <div class="mb-3">
            <label class="form-label">图形验证码</label>
            <div class="row g-2">
              <div class="col-7">
                <input type="text" class="form-control" id="captchaCode" placeholder="输入4位验证码" maxlength="4">
              </div>
              <div class="col-5">
                <div class="captcha-container" style="position: relative;">
                  <img id="captchaImage" src="" alt="图形验证码"
                       style="width: 100%; height: 38px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;"
                       onclick="refreshCaptcha()">
                  <div id="captchaLoading" class="text-center" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-text">
              <span id="captchaStatus">请输入图形验证码，点击图片可刷新</span>
            </div>
          </div>

          <!-- 邮箱验证码 -->
          <div class="input-group">
            <input type="text" class="form-control" id="verificationCode" placeholder="输入6位验证码" maxlength="6">
            <button type="button" class="btn btn-outline-secondary" id="sendCodeBtn" onclick="sendVerificationCode()" disabled>
              发送验证码
            </button>
          </div>
          <div class="form-text mb-3">
            <span id="codeStatus">请先验证图形验证码</span>
          </div>
        </div>

        <div id="errorAlert" class="alert alert-danger d-none" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <span id="errorMessage"></span>
        </div>

        <button type="submit" class="btn btn-primary btn-login">
          <span class="loading spinner-border spinner-border-sm me-2" role="status"></span>
          <span id="loginText">登录</span>
        </button>
      </form>

      <!-- 注册链接 -->
      <div id="registerSection" class="text-center mt-3">
        <span class="text-muted">还没有账号？</span>
        <a href="/register.html" class="text-decoration-none">
          <i class="bi bi-person-plus me-1"></i>立即注册
        </a>
      </div>

      <!-- 默认账号提示 -->
      <div id="defaultLoginInfo" class="mt-4 p-3 bg-light rounded-3">
        <div class="text-center">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            默认登录账号
          </small>
        </div>
        <div class="mt-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">用户名：</small>
            <code class="bg-white px-2 py-1 rounded">admin</code>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">密码：</small>
            <code class="bg-white px-2 py-1 rounded">admin123</code>
          </div>
        </div>
        <div class="text-center mt-2">
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="fillDefaultCredentials()">
            <i class="bi bi-arrow-down-circle me-1"></i>
            使用默认账号
          </button>
        </div>
      </div>

    </div>
  </div>

  <script src="/static/lib/bootstrap/bootstrap.bundle.min.js"></script>
  <script>
    const loginForm = document.getElementById('loginForm');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const loading = document.querySelector('.loading');
    const loginText = document.getElementById('loginText');
    
    function showError(message) {
      errorMessage.textContent = message;
      errorAlert.classList.remove('d-none');
    }
    
    function hideError() {
      errorAlert.classList.add('d-none');
    }
    
    function setLoading(isLoading) {
      if (isLoading) {
        loading.classList.add('show');
        loginText.textContent = '登录中...';
        loginForm.querySelector('button').disabled = true;
      } else {
        loading.classList.remove('show');
        loginText.textContent = '登录';
        loginForm.querySelector('button').disabled = false;
      }
    }

    // 填充默认登录凭据
    function fillDefaultCredentials() {
      document.getElementById('username').value = 'admin';
      document.getElementById('password').value = 'admin123';
      hideError();

      // 添加一个小动画效果
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');

      usernameInput.style.backgroundColor = '#e3f2fd';
      passwordInput.style.backgroundColor = '#e3f2fd';

      setTimeout(() => {
        usernameInput.style.backgroundColor = '';
        passwordInput.style.backgroundColor = '';
      }, 1000);
    }
    
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();
      setLoading(true);

      const loginType = document.querySelector('input[name="loginType"]:checked').value;
      let loginData = {};

      try {
        if (loginType === 'username') {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;

          if (!username || !password) {
            showError('请输入用户名和密码');
            return;
          }

          loginData = { username, password };
        } else if (loginType === 'email-password') {
          const email = document.getElementById('emailForPassword').value;
          const password = document.getElementById('emailPassword').value;

          if (!email || !password) {
            showError('请输入邮箱和密码');
            return;
          }

          if (!validateEmail(email)) {
            showError('请输入有效的邮箱地址');
            return;
          }

          loginData = { email, password };
        } else if (loginType === 'email-code') {
          const email = document.getElementById('emailForCode').value;
          const verificationCode = document.getElementById('verificationCode').value;

          if (!captchaVerified) {
            showError('请先验证图形验证码');
            return;
          }

          if (!email) {
            showError('请输入邮箱地址');
            return;
          }

          if (!validateEmail(email)) {
            showError('请输入有效的邮箱地址');
            return;
          }

          if (!verificationCode || verificationCode.length !== 6) {
            showError('请输入6位验证码');
            return;
          }

          loginData = { email, verification_code: verificationCode };
        }

        const response = await fetch('/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(loginData)
        });

        const result = await response.json();

        if (result.success) {
          // 保存token到localStorage
          localStorage.setItem('auth_token', result.token);

          // 保存用户信息到localStorage
          const userInfo = {
            user_id: result.user_id,
            username: result.username,
            is_admin: result.is_admin
          };
          localStorage.setItem('user_info', JSON.stringify(userInfo));

          // 检查是否有重定向URL
          const redirectUrl = localStorage.getItem('redirectAfterLogin');
          if (redirectUrl) {
            // 清除重定向URL
            localStorage.removeItem('redirectAfterLogin');
            // 跳转到原来的页面
            window.location.href = redirectUrl;
          } else {
            // 默认跳转到管理页面
            window.location.href = '/admin';
          }
        } else {
          showError(result.message);
        }
      } catch (error) {
        showError('登录失败，请检查网络连接');
      } finally {
        setLoading(false);
      }
    });
    
    // 检查是否已经登录
    const token = localStorage.getItem('auth_token');
    if (token) {
      // 验证token是否有效
      fetch('/verify', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(result => {
        if (result.authenticated) {
          window.location.href = '/admin';
        }
      })
      .catch(() => {
        // token无效，清除
        localStorage.removeItem('auth_token');
      });
    }

    // 登录方式切换相关变量
    let captchaVerified = false;
    let countdownTimer = null;
    let countdownSeconds = 0;
    let sessionId = generateSessionId();

    // 生成会话ID
    function generateSessionId() {
      return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }

    // 登录方式切换
    function switchLoginType() {
      const loginType = document.querySelector('input[name="loginType"]:checked').value;

      // 隐藏所有表单
      document.querySelectorAll('.login-form-section').forEach(section => {
        section.style.display = 'none';
      });

      // 显示对应表单
      if (loginType === 'username') {
        document.getElementById('usernameLoginForm').style.display = 'block';
      } else if (loginType === 'email-password') {
        document.getElementById('emailPasswordLoginForm').style.display = 'block';
      } else if (loginType === 'email-code') {
        document.getElementById('emailCodeLoginForm').style.display = 'block';
        // 每次切换到邮箱验证码登录时都加载验证码
        loadCaptcha();
      }

      hideError();
    }

    // 加载图形验证码
    async function loadCaptcha() {
      const captchaImage = document.getElementById('captchaImage');
      const captchaLoading = document.getElementById('captchaLoading');
      const captchaStatus = document.getElementById('captchaStatus');

      captchaLoading.style.display = 'block';
      captchaImage.style.display = 'none';

      try {
        const response = await fetch('/generate-captcha', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ session_id: sessionId })
        });

        const result = await response.json();

        if (result.success) {
          captchaImage.src = result.captcha_image;
          captchaStatus.textContent = '请输入图形验证码，点击图片可刷新';
          captchaVerified = false;
          updateSendCodeButton();
        } else {
          captchaStatus.textContent = '图形验证码加载失败，请刷新页面重试';
        }
      } catch (error) {
        console.error('加载图形验证码失败:', error);
        captchaStatus.textContent = '图形验证码加载失败，请检查网络连接';
      } finally {
        captchaLoading.style.display = 'none';
        captchaImage.style.display = 'block';
      }
    }

    // 刷新图形验证码
    function refreshCaptcha() {
      loadCaptcha();
    }

    // 验证图形验证码
    async function verifyCaptcha() {
      const captchaCode = document.getElementById('captchaCode').value.trim();
      const captchaStatus = document.getElementById('captchaStatus');

      if (!captchaCode) {
        captchaStatus.textContent = '请输入图形验证码';
        captchaVerified = false;
        updateSendCodeButton();
        return;
      }

      try {
        const response = await fetch('/verify-captcha', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session_id: sessionId,
            captcha_code: captchaCode
          })
        });

        const result = await response.json();

        if (result.success) {
          captchaStatus.innerHTML = '<span style="color: green;">✓ 图形验证码验证成功</span>';
          captchaVerified = true;
        } else {
          captchaStatus.innerHTML = '<span style="color: red;">✗ 图形验证码错误，请重新输入</span>';
          captchaVerified = false;
          refreshCaptcha(); // 自动刷新验证码
        }

        updateSendCodeButton();

      } catch (error) {
        console.error('验证图形验证码失败:', error);
        captchaStatus.innerHTML = '<span style="color: red;">验证失败，请检查网络连接</span>';
        captchaVerified = false;
        updateSendCodeButton();
      }
    }

    // 更新发送验证码按钮状态
    function updateSendCodeButton() {
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      const email = document.getElementById('emailForCode').value.trim();
      const codeStatus = document.getElementById('codeStatus');

      if (captchaVerified && email && validateEmail(email)) {
        sendCodeBtn.disabled = false;
        codeStatus.textContent = '图形验证码已验证，可以发送邮箱验证码';
      } else {
        sendCodeBtn.disabled = true;
        if (!captchaVerified) {
          codeStatus.textContent = '请先验证图形验证码';
        } else if (!email) {
          codeStatus.textContent = '请先输入邮箱地址';
        } else if (!validateEmail(email)) {
          codeStatus.textContent = '请输入有效的邮箱地址';
        }
      }
    }

    // 邮箱格式验证
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // 开始倒计时
    function startCountdown() {
      countdownSeconds = 60;
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      const codeStatus = document.getElementById('codeStatus');

      sendCodeBtn.disabled = true;

      countdownTimer = setInterval(() => {
        countdownSeconds--;
        sendCodeBtn.textContent = `重新发送 (${countdownSeconds}s)`;
        codeStatus.innerHTML = `<span class="countdown">验证码已发送，${countdownSeconds}秒后可重新发送</span>`;

        if (countdownSeconds <= 0) {
          clearInterval(countdownTimer);
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = '发送验证码';
          codeStatus.textContent = '可以重新发送验证码';
        }
      }, 1000);
    }

    // 发送邮箱验证码
    async function sendVerificationCode() {
      const email = document.getElementById('emailForCode').value.trim();

      if (!captchaVerified) {
        showError('请先验证图形验证码');
        return;
      }

      if (!email) {
        showError('请先输入邮箱地址');
        return;
      }

      if (!validateEmail(email)) {
        showError('请输入有效的邮箱地址');
        return;
      }

      try {
        const response = await fetch('/send-verification-code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            type: 'login',
            session_id: sessionId
          })
        });

        const result = await response.json();

        if (result.success) {
          startCountdown();
        } else {
          showError(result.message);
        }
      } catch (error) {
        console.error('发送验证码失败:', error);
        showError('发送验证码失败，请检查网络连接');
      }
    }

    // 检查注册状态
    async function checkRegistrationStatus() {
      try {
        const response = await fetch('/registration-status');
        if (response.ok) {
          const data = await response.json();
          const registerSection = document.getElementById('registerSection');
          if (registerSection) {
            registerSection.style.display = data.enabled ? 'block' : 'none';
          }
        }
      } catch (error) {
        console.error('检查注册状态失败:', error);
        // 出错时默认显示注册链接
      }
    }

    // 检查默认登录信息显示状态
    async function checkLoginInfoStatus() {
      try {
        const response = await fetch('/login-info-status');
        const result = await response.json();

        const defaultLoginInfo = document.getElementById('defaultLoginInfo');
        if (result.enabled) {
          defaultLoginInfo.style.display = 'block';
        } else {
          defaultLoginInfo.style.display = 'none';
        }
      } catch (error) {
        console.error('检查登录信息显示状态失败:', error);
        // 出错时默认显示
        document.getElementById('defaultLoginInfo').style.display = 'block';
      }
    }

    // 事件监听器
    document.addEventListener('DOMContentLoaded', function() {
      // 检查注册状态
      checkRegistrationStatus();

      // 检查默认登录信息显示状态
      checkLoginInfoStatus();

      // 登录方式切换
      document.querySelectorAll('input[name="loginType"]').forEach(radio => {
        radio.addEventListener('change', switchLoginType);
      });

      // 图形验证码输入框事件
      const captchaCodeInput = document.getElementById('captchaCode');
      if (captchaCodeInput) {
        captchaCodeInput.addEventListener('input', function() {
          if (this.value.length === 4) {
            verifyCaptcha();
          } else {
            captchaVerified = false;
            updateSendCodeButton();
            document.getElementById('captchaStatus').textContent = '请输入4位图形验证码';
          }
        });
      }

      // 邮箱输入框事件
      const emailForCodeInput = document.getElementById('emailForCode');
      if (emailForCodeInput) {
        emailForCodeInput.addEventListener('input', updateSendCodeButton);
      }

      // 初始化主题
      initTheme();
    });

    // 主题切换功能
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);

      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const themeIcon = document.getElementById('themeIcon');
      if (theme === 'dark') {
        themeIcon.className = 'bi bi-moon-fill';
      } else {
        themeIcon.className = 'bi bi-sun-fill';
      }
    }

    function initTheme() {
      // 从localStorage获取保存的主题，或根据系统偏好设置默认主题
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const defaultTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

      document.documentElement.setAttribute('data-theme', defaultTheme);
      updateThemeIcon(defaultTheme);

      // 监听系统主题变化
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          const newTheme = e.matches ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', newTheme);
          updateThemeIcon(newTheme);
        }
      });
    }
  </script>
</body>
</html>
