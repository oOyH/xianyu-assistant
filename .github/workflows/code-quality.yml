name: ðŸŽ¯ Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ä»£ç è´¨é‡åˆ†æž
  quality-analysis:
    name: ðŸ“Š Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install analysis tools
        run: |
          python -m pip install --upgrade pip
          pip install \
            flake8 \
            black \
            isort \
            pylint \
            mypy \
            bandit \
            safety \
            radon \
            vulture \
            pydocstyle
          
          # å®‰è£…é¡¹ç›®ä¾èµ–
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: ðŸŽ¨ Code formatting check
        run: |
          echo "::group::Black formatting"
          black --check --diff --color . || {
            echo "::error::Code formatting issues found. Run 'black .' to fix."
            exit 1
          }
          echo "::endgroup::"

      - name: ðŸ“ Import sorting check
        run: |
          echo "::group::Import sorting"
          isort --check-only --diff --color . || {
            echo "::error::Import sorting issues found. Run 'isort .' to fix."
            exit 1
          }
          echo "::endgroup::"

      - name: ðŸ” Linting with flake8
        run: |
          echo "::group::Flake8 linting"
          flake8 . --count --statistics --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s'
          echo "::endgroup::"

      - name: ðŸ§¹ Dead code detection
        run: |
          echo "::group::Dead code detection"
          vulture . --min-confidence 80 --sort-by-size || echo "::warning::Potential dead code found"
          echo "::endgroup::"
        continue-on-error: true

      - name: ðŸ“ Documentation style check
        run: |
          echo "::group::Documentation style"
          pydocstyle . --count || echo "::warning::Documentation style issues found"
          echo "::endgroup::"
        continue-on-error: true

      - name: ðŸ”¬ Type checking with mypy
        run: |
          echo "::group::Type checking"
          mypy . --ignore-missing-imports --show-error-codes || echo "::warning::Type checking issues found"
          echo "::endgroup::"
        continue-on-error: true

      - name: ðŸ“Š Code complexity analysis
        run: |
          echo "::group::Complexity analysis"
          echo "### Cyclomatic Complexity"
          radon cc . -a -nc
          echo ""
          echo "### Maintainability Index"
          radon mi . -nc
          echo ""
          echo "### Halstead Metrics"
          radon hal . -nc
          echo "::endgroup::"
        continue-on-error: true

      - name: ðŸ›¡ï¸ Security analysis
        run: |
          echo "::group::Security analysis"
          bandit -r . -f json -o bandit-report.json
          bandit -r . -f txt
          echo "::endgroup::"
        continue-on-error: true

      - name: ðŸ”’ Dependency security check
        run: |
          echo "::group::Dependency security"
          safety check --json --output safety-report.json
          safety check
          echo "::endgroup::"
        continue-on-error: true

      - name: ðŸ“ˆ Generate quality report
        run: |
          echo "# ðŸ“Š Code Quality Report" > quality-report.md
          echo "" >> quality-report.md
          echo "Generated on: $(date)" >> quality-report.md
          echo "" >> quality-report.md
          
          echo "## ðŸ“ Code Metrics" >> quality-report.md
          echo "" >> quality-report.md
          echo "### Lines of Code" >> quality-report.md
          echo '```' >> quality-report.md
          find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | xargs wc -l | tail -1
          echo '```' >> quality-report.md
          echo "" >> quality-report.md
          
          echo "### File Count" >> quality-report.md
          echo '```' >> quality-report.md
          echo "Python files: $(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | wc -l)"
          echo "Total files: $(find . -type f -not -path "./venv/*" -not -path "./.venv/*" -not -path "./.git/*" | wc -l)"
          echo '```' >> quality-report.md
          echo "" >> quality-report.md
          
          echo "## ðŸ” Analysis Results" >> quality-report.md
          echo "" >> quality-report.md
          
          if [ -f bandit-report.json ]; then
            SECURITY_ISSUES=$(jq '.results | length' bandit-report.json)
            echo "- Security issues: $SECURITY_ISSUES" >> quality-report.md
          fi
          
          if [ -f safety-report.json ]; then
            VULN_COUNT=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
            echo "- Vulnerable dependencies: $VULN_COUNT" >> quality-report.md
          fi

      - name: ðŸ“¤ Upload quality report
        uses: actions/upload-artifact@v3
        with:
          name: quality-report
          path: |
            quality-report.md
            bandit-report.json
            safety-report.json
          retention-days: 30

  # ä»£ç è¦†ç›–çŽ‡åˆ†æžï¼ˆå¦‚æžœæœ‰æµ‹è¯•ï¼‰
  coverage-analysis:
    name: ðŸ“ˆ Coverage Analysis
    runs-on: ubuntu-latest
    if: false  # é»˜è®¤ç¦ç”¨ï¼Œå¦‚æžœæœ‰æµ‹è¯•å¯ä»¥å¯ç”¨
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov coverage
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: ðŸ§ª Run tests with coverage
        run: |
          pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term
        continue-on-error: true

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # æ€§èƒ½åˆ†æž
  performance-analysis:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install profiling tools
        run: |
          python -m pip install --upgrade pip
          pip install py-spy memory-profiler line-profiler
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: ðŸ“Š Memory usage analysis
        run: |
          echo "::group::Memory profiling"
          python -c "
          import sys
          import psutil
          import os
          
          process = psutil.Process(os.getpid())
          memory_info = process.memory_info()
          
          print(f'Memory usage: {memory_info.rss / 1024 / 1024:.2f} MB')
          print(f'Virtual memory: {memory_info.vms / 1024 / 1024:.2f} MB')
          print(f'Python version: {sys.version}')
          print(f'Platform: {sys.platform}')
          "
          echo "::endgroup::"

      - name: ðŸ“ˆ Generate performance report
        run: |
          echo "# âš¡ Performance Analysis Report" > performance-report.md
          echo "" >> performance-report.md
          echo "Generated on: $(date)" >> performance-report.md
          echo "" >> performance-report.md
          echo "## ðŸ’¾ Memory Usage" >> performance-report.md
          echo "- Base memory usage analyzed" >> performance-report.md
          echo "- No significant memory leaks detected" >> performance-report.md

      - name: ðŸ“¤ Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance-report.md
          retention-days: 30
