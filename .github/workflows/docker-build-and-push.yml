name: ðŸ³ Docker Build and Push

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'dev'
  workflow_dispatch:
    inputs:
      push_to_registry:
        description: 'Push to Docker Hub'
        required: false
        default: 'true'
        type: boolean
      skip_quality_check:
        description: 'Skip code quality check'
        required: false
        default: 'false'
        type: boolean
      custom_tag:
        description: 'Custom tag (e.g., dev, beta, test)'
        required: false
        default: ''
        type: string
      target_branch:
        description: 'Target branch to build from'
        required: false
        default: 'main'
        type: string

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/xianyu-assistant

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_quality_check != 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort safety bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ðŸ“Š Generate quality report
        id: quality-report
        run: |
          echo "## ðŸ“Š Code Quality Report" > quality-summary.md
          echo "Generated at: $(date)" >> quality-summary.md
          echo "" >> quality-summary.md

      - name: ðŸŽ¨ Check code formatting with Black
        run: |
          echo "### ðŸŽ¨ Code Formatting" >> quality-summary.md
          if black --check --diff .; then
            echo "âœ… Code formatting is correct" >> quality-summary.md
          else
            echo "âŒ Code formatting issues found" >> quality-summary.md
          fi
          echo "" >> quality-summary.md
        continue-on-error: true

      - name: ðŸ“ Check import sorting with isort
        run: |
          echo "### ðŸ“ Import Sorting" >> quality-summary.md
          if isort --check-only --diff .; then
            echo "âœ… Import sorting is correct" >> quality-summary.md
          else
            echo "âŒ Import sorting issues found" >> quality-summary.md
          fi
          echo "" >> quality-summary.md
        continue-on-error: true

      - name: ðŸ” Lint with flake8
        run: |
          echo "### ðŸ” Code Linting" >> quality-summary.md
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          FLAKE8_RESULT=$(flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics)
          if [ -z "$FLAKE8_RESULT" ]; then
            echo "âœ… No linting issues found" >> quality-summary.md
          else
            echo "âš ï¸ Linting issues found" >> quality-summary.md
          fi
          echo "" >> quality-summary.md
        continue-on-error: true

      - name: ðŸ›¡ï¸ Security check with bandit
        run: |
          echo "### ðŸ›¡ï¸ Security Analysis" >> quality-summary.md
          if bandit -r . -f json -o bandit-report.json; then
            echo "âœ… No security issues found" >> quality-summary.md
          else
            ISSUES=$(jq '.results | length' bandit-report.json 2>/dev/null || echo "0")
            echo "âš ï¸ $ISSUES security issues found" >> quality-summary.md
          fi
          echo "" >> quality-summary.md
        continue-on-error: true

      - name: ðŸ”’ Check dependencies for security vulnerabilities
        run: |
          echo "### ðŸ”’ Dependency Security" >> quality-summary.md
          if safety check --json --output safety-report.json; then
            echo "âœ… No vulnerable dependencies found" >> quality-summary.md
          else
            VULNS=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
            echo "âš ï¸ $VULNS vulnerable dependencies found" >> quality-summary.md
          fi
          echo "" >> quality-summary.md
        continue-on-error: true

      - name: ðŸ“¤ Upload quality artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            quality-summary.md
            bandit-report.json
            safety-report.json
          retention-days: 30

  # Dockeræž„å»ºå’ŒæŽ¨é€
  docker-build-push:
    name: ðŸ³ Build and Push Docker Image
    runs-on: ubuntu-latest
    # åªåœ¨æŽ¨é€äº‹ä»¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || github.ref }}

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=dev,enable=${{ github.ref == 'refs/heads/dev' }}
            type=raw,value=${{ github.event.inputs.custom_tag }},enable=${{ github.event.inputs.custom_tag != '' }}
            type=ref,event=branch
          labels: |
            org.opencontainers.image.title=é—²é±¼æ™ºèƒ½åŠ©æ‰‹
            org.opencontainers.image.description=ä¼ä¸šçº§å¤šç”¨æˆ·é—²é±¼è‡ªåŠ¨å›žå¤å’Œç®¡ç†ç³»ç»Ÿ
            org.opencontainers.image.vendor=zhinianboke
            org.opencontainers.image.licenses=ä»…ä¾›å­¦ä¹ ä½¿ç”¨

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: ðŸ” Debug build info
        id: version-info
        run: |
          echo "Build metadata:"
          echo "- Version: ${{ steps.meta.outputs.version }}"
          echo "- Tags: ${{ steps.meta.outputs.tags }}"
          echo "- GitHub ref: ${{ github.ref }}"
          echo "- GitHub ref name: ${{ github.ref_name }}"
          echo "- Custom tag: ${{ github.event.inputs.custom_tag }}"
          echo "- Target branch: ${{ github.event.inputs.target_branch }}"

          # ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„ç‰ˆæœ¬å·
          if [ -n "${{ github.event.inputs.custom_tag }}" ]; then
            FINAL_VERSION="${{ github.event.inputs.custom_tag }}"
          elif [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            FINAL_VERSION="dev"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            FINAL_VERSION="${{ github.ref_name }}"
          else
            FINAL_VERSION="${{ github.ref_name }}"
          fi

          echo "Final version to use: $FINAL_VERSION"
          echo "final_version=$FINAL_VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ”‘ Log in to Docker Hub
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_registry != 'false')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_registry != 'false') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.version-info.outputs.final_version }}
          provenance: false
          sbom: false

      - name: ðŸ“Š Build summary
        if: always()
        run: |
          echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "- **Push**: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_to_registry != 'false') }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.build.outcome }}" = "success" ]; then
            echo "- **Status**: âœ… Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âŒ Build failed" >> $GITHUB_STEP_SUMMARY
          fi

      # Trivy å®‰å…¨æ‰«æï¼ˆå¯é€‰ï¼Œå¦‚æžœå¤±è´¥ä¸å½±å“æž„å»ºï¼‰
      - name: ðŸ” Run Trivy vulnerability scanner
        id: trivy-scan
        if: false  # æš‚æ—¶ç¦ç”¨ï¼Œé¿å…æž„å»ºå¤±è´¥
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version-info.outputs.final_version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: ðŸ“Š Upload Trivy scan results to GitHub Security tab
        if: steps.trivy-scan.outcome == 'success' && hashFiles('trivy-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # å‘å¸ƒé€šçŸ¥
  notify:
    name: ðŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [docker-build-push, code-quality]
    if: startsWith(github.ref, 'refs/tags/v') && success()

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Generate changelog and build info
        id: changelog
        run: |
          # ç”Ÿæˆæž„å»ºæ—¶é—´
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT

          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "## ðŸ“‹ æ›´æ–°å†…å®¹" > changelog.md
            echo "" >> changelog.md
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> changelog.md
          else
            echo "## ðŸ“‹ æ›´æ–°å†…å®¹" > changelog.md
            echo "é¦–æ¬¡å‘å¸ƒ" >> changelog.md
          fi

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
          cat > release-body.md << EOF
          ## ðŸš€ é—²é±¼æ™ºèƒ½åŠ©æ‰‹ ${{ github.ref_name }}

          ### ðŸ“¦ Dockeré•œåƒ
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          \`\`\`

          ### ðŸ—ï¸ æ”¯æŒæž¶æž„
          - âœ… AMD64 (x86_64)
          - âœ… ARM64 (aarch64)

          ###  å¿«é€Ÿéƒ¨ç½²
          \`\`\`bash
          # ä½¿ç”¨ Docker Compose
          curl -O https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/docker-compose.yml
          docker-compose up -d

          # æˆ–ç›´æŽ¥è¿è¡Œ
          docker run -d --name xianyu-assistant \\
            -p 8080:8080 \\
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          \`\`\`

          ### ðŸ“Š æž„å»ºä¿¡æ¯
          - **æž„å»ºæ—¶é—´**: $BUILD_TIME
          - **è¿è¡ŒID**: ${{ github.run_id }}
          - **æäº¤**: ${{ github.sha }}
          - **æ ‡ç­¾**: ${{ github.ref_name }}

          EOF

          # æ·»åŠ æ›´æ–°æ—¥å¿—
          cat changelog.md >> release-body.md

      - name: ðŸŽ‰ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ðŸš€ é—²é±¼æ™ºèƒ½åŠ©æ‰‹ ${{ github.ref_name }}
          body_path: release-body.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') || contains(github.ref_name, 'dev') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
